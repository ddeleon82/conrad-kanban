<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Conrad's Kanban | Freedom & Coffee</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      min-height: 100vh;
      color: #e4e4e7;
    }
    
    header {
      padding: 24px 32px;
      background: rgba(0,0,0,0.3);
      border-bottom: 1px solid rgba(255,255,255,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    header h1 {
      font-size: 24px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    header h1 span { font-size: 28px; }
    
    .stats {
      display: flex;
      gap: 24px;
      font-size: 14px;
      color: #a1a1aa;
    }
    
    .stats .stat {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .stats .stat-value {
      color: #e4e4e7;
      font-weight: 600;
    }
    
    .board {
      display: flex;
      gap: 20px;
      padding: 32px;
      overflow-x: auto;
      min-height: calc(100vh - 88px);
    }
    
    .column {
      background: rgba(255,255,255,0.05);
      border-radius: 12px;
      min-width: 300px;
      max-width: 300px;
      display: flex;
      flex-direction: column;
    }
    
    .column-header {
      padding: 16px 20px;
      font-weight: 600;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .column-header .count {
      background: rgba(255,255,255,0.1);
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 12px;
    }
    
    .column[data-id="backlog"] .column-header { color: #a1a1aa; }
    .column[data-id="todo"] .column-header { color: #60a5fa; }
    .column[data-id="in-progress"] .column-header { color: #fbbf24; }
    .column[data-id="done"] .column-header { color: #34d399; }
    
    .column-content {
      padding: 12px;
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .task {
      background: rgba(255,255,255,0.08);
      border-radius: 8px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.2s;
      border: 1px solid transparent;
    }
    
    .task:hover {
      background: rgba(255,255,255,0.12);
      border-color: rgba(255,255,255,0.2);
      transform: translateY(-2px);
    }
    
    .task-title {
      font-weight: 500;
      margin-bottom: 8px;
      font-size: 15px;
    }
    
    .task-description {
      font-size: 13px;
      color: #a1a1aa;
      margin-bottom: 12px;
      line-height: 1.5;
    }
    
    .task-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
    }
    
    .task-assignee {
      display: flex;
      align-items: center;
      gap: 6px;
      color: #a1a1aa;
    }
    
    .task-assignee .avatar {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: 600;
      color: white;
    }
    
    .task-assignee.dom .avatar {
      background: linear-gradient(135deg, #f59e0b, #ef4444);
    }
    
    .task-priority {
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
      text-transform: uppercase;
    }
    
    .task-priority.high { background: rgba(239, 68, 68, 0.2); color: #f87171; }
    .task-priority.medium { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
    .task-priority.low { background: rgba(52, 211, 153, 0.2); color: #34d399; }
    
    .task-comment-indicator {
      margin-left: 8px;
      font-size: 11px;
      color: #60a5fa;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: #71717a;
    }
    
    .refresh-note {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.8);
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 13px;
      color: #a1a1aa;
    }
    
    /* Modal Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
    }
    
    .modal-overlay.open {
      opacity: 1;
      visibility: visible;
    }
    
    .modal {
      background: #1e1e2e;
      border-radius: 16px;
      width: 90%;
      max-width: 600px;
      max-height: 85vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      border: 1px solid rgba(255,255,255,0.1);
      transform: scale(0.9);
      transition: transform 0.3s;
    }
    
    .modal-overlay.open .modal {
      transform: scale(1);
    }
    
    .modal-header {
      padding: 24px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }
    
    .modal-header h2 {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 8px;
    }
    
    .modal-header .status-badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
      text-transform: uppercase;
    }
    
    .modal-header .status-badge.todo { background: rgba(96, 165, 250, 0.2); color: #60a5fa; }
    .modal-header .status-badge.in-progress { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
    .modal-header .status-badge.done { background: rgba(52, 211, 153, 0.2); color: #34d399; }
    .modal-header .status-badge.backlog { background: rgba(161, 161, 170, 0.2); color: #a1a1aa; }
    
    .modal-close {
      background: rgba(255,255,255,0.1);
      border: none;
      color: #a1a1aa;
      width: 32px;
      height: 32px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    
    .modal-close:hover {
      background: rgba(255,255,255,0.2);
      color: white;
    }
    
    .modal-body {
      padding: 24px;
      overflow-y: auto;
      flex: 1;
    }
    
    .modal-section {
      margin-bottom: 24px;
    }
    
    .modal-section:last-child {
      margin-bottom: 0;
    }
    
    .modal-section h3 {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #71717a;
      margin-bottom: 12px;
    }
    
    .modal-section p {
      color: #a1a1aa;
      line-height: 1.6;
    }
    
    .deliverable-link {
      display: flex;
      align-items: center;
      gap: 10px;
      background: rgba(99, 102, 241, 0.1);
      border: 1px solid rgba(99, 102, 241, 0.3);
      padding: 12px 16px;
      border-radius: 8px;
      color: #818cf8;
      text-decoration: none;
      transition: all 0.2s;
    }
    
    .deliverable-link:hover {
      background: rgba(99, 102, 241, 0.2);
      border-color: rgba(99, 102, 241, 0.5);
    }
    
    .deliverable-link .icon {
      font-size: 20px;
    }
    
    .deliverable-link .path {
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 13px;
    }
    
    .comments-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-bottom: 16px;
    }
    
    .comment {
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      padding: 12px 16px;
    }
    
    .comment-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }
    
    .comment-author {
      font-weight: 500;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .comment-author .avatar {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: linear-gradient(135deg, #f59e0b, #ef4444);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }
    
    .comment-time {
      font-size: 11px;
      color: #71717a;
    }
    
    .comment-text {
      color: #d4d4d8;
      font-size: 14px;
      line-height: 1.5;
    }
    
    .comment-form {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .comment-form textarea {
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      padding: 12px;
      color: #e4e4e7;
      font-family: inherit;
      font-size: 14px;
      resize: vertical;
      min-height: 80px;
    }
    
    .comment-form textarea:focus {
      outline: none;
      border-color: rgba(99, 102, 241, 0.5);
    }
    
    .comment-form textarea::placeholder {
      color: #71717a;
    }
    
    .comment-form button {
      align-self: flex-end;
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      border: none;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .comment-form button:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
    }
    
    .no-comments {
      color: #71717a;
      font-size: 14px;
      text-align: center;
      padding: 20px;
    }
    
    .meta-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }
    
    .meta-item {
      background: rgba(255,255,255,0.03);
      padding: 12px;
      border-radius: 8px;
    }
    
    .meta-item label {
      font-size: 11px;
      text-transform: uppercase;
      color: #71717a;
      display: block;
      margin-bottom: 4px;
    }
    
    .meta-item value {
      font-size: 14px;
      color: #e4e4e7;
    }
    
    /* Toast notification */
    .toast {
      position: fixed;
      bottom: 80px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: #34d399;
      color: #0f172a;
      padding: 16px 24px;
      border-radius: 8px;
      font-weight: 500;
      opacity: 0;
      transition: all 0.3s;
      z-index: 1001;
    }
    
    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }
  </style>
</head>
<body>
  <header>
    <h1><span>ðŸŽ­</span> Conrad's Kanban</h1>
    <div class="stats">
      <div class="stat">
        <span>Backlog:</span>
        <span class="stat-value" id="stat-backlog">0</span>
      </div>
      <div class="stat">
        <span>To Do:</span>
        <span class="stat-value" id="stat-todo">0</span>
      </div>
      <div class="stat">
        <span>In Progress:</span>
        <span class="stat-value" id="stat-in-progress">0</span>
      </div>
      <div class="stat">
        <span>Done:</span>
        <span class="stat-value" id="stat-done">0</span>
      </div>
    </div>
  </header>
  
  <div class="board" id="board"></div>
  
  <div class="refresh-note">
    ðŸ’¡ Conrad updates this board as he works. Refresh to see latest.
  </div>
  
  <!-- Task Detail Modal -->
  <div class="modal-overlay" id="modal-overlay">
    <div class="modal">
      <div class="modal-header">
        <div>
          <h2 id="modal-title">Task Title</h2>
          <span class="status-badge" id="modal-status">Status</span>
        </div>
        <button class="modal-close" onclick="closeModal()">Ã—</button>
      </div>
      <div class="modal-body">
        <div class="modal-section" id="modal-description-section">
          <h3>Description</h3>
          <p id="modal-description"></p>
        </div>
        
        <div class="modal-section" id="modal-deliverable-section">
          <h3>Deliverable</h3>
          <a href="#" class="deliverable-link" id="modal-deliverable" target="_blank">
            <span class="icon">ðŸ“„</span>
            <span class="path" id="modal-deliverable-path"></span>
          </a>
        </div>
        
        <div class="modal-section">
          <h3>Details</h3>
          <div class="meta-grid">
            <div class="meta-item">
              <label>Assignee</label>
              <value id="modal-assignee">-</value>
            </div>
            <div class="meta-item">
              <label>Priority</label>
              <value id="modal-priority">-</value>
            </div>
            <div class="meta-item" id="modal-completed-section">
              <label>Completed</label>
              <value id="modal-completed">-</value>
            </div>
            <div class="meta-item" id="modal-notes-section">
              <label>Notes</label>
              <value id="modal-notes">-</value>
            </div>
          </div>
        </div>
        
        <div class="modal-section">
          <h3>Comments</h3>
          <div class="comments-list" id="comments-list">
            <div class="no-comments">No comments yet</div>
          </div>
          <div class="comment-form">
            <textarea id="comment-input" placeholder="Add a comment... (this will move the task back to To Do)"></textarea>
            <button onclick="addComment()">Add Comment</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="toast" id="toast">Comment added! Task moved to To Do.</div>

  <script>
    let boardData = null;
    let currentTaskId = null;
    let localComments = JSON.parse(localStorage.getItem('kanban-comments') || '{}');
    
    async function loadBoard() {
      try {
        const res = await fetch('tasks.json?' + Date.now());
        boardData = await res.json();
        renderBoard(boardData);
      } catch (err) {
        console.error('Failed to load tasks:', err);
      }
    }
    
    function getTaskComments(taskId) {
      const serverComments = boardData.tasks.find(t => t.id === taskId)?.comments || [];
      const local = localComments[taskId] || [];
      return [...serverComments, ...local].sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
    }
    
    function getEffectiveColumn(task) {
      // If there are local comments, task should be in "todo"
      if (localComments[task.id] && localComments[task.id].length > 0) {
        return 'todo';
      }
      return task.column;
    }
    
    function renderBoard(data) {
      const board = document.getElementById('board');
      board.innerHTML = '';
      
      const tasksByColumn = {};
      data.columns.forEach(col => tasksByColumn[col.id] = []);
      
      data.tasks.forEach(task => {
        const effectiveColumn = getEffectiveColumn(task);
        if (tasksByColumn[effectiveColumn]) {
          tasksByColumn[effectiveColumn].push({...task, effectiveColumn});
        }
      });
      
      // Update stats
      data.columns.forEach(col => {
        const statEl = document.getElementById('stat-' + col.id);
        if (statEl) statEl.textContent = tasksByColumn[col.id].length;
      });
      
      data.columns.forEach(col => {
        const column = document.createElement('div');
        column.className = 'column';
        column.dataset.id = col.id;
        
        const tasks = tasksByColumn[col.id];
        
        column.innerHTML = `
          <div class="column-header">
            <span>${col.name}</span>
            <span class="count">${tasks.length}</span>
          </div>
          <div class="column-content">
            ${tasks.length === 0 ? '<div class="empty-state">No tasks</div>' : ''}
            ${tasks.map(task => {
              const comments = getTaskComments(task.id);
              const hasComments = comments.length > 0;
              return `
                <div class="task" data-id="${task.id}" onclick="openModal('${task.id}')">
                  <div class="task-title">
                    ${task.title}
                    ${hasComments ? `<span class="task-comment-indicator">ðŸ’¬ ${comments.length}</span>` : ''}
                  </div>
                  ${task.description ? `<div class="task-description">${task.description}</div>` : ''}
                  <div class="task-meta">
                    <div class="task-assignee ${task.assignee}">
                      <div class="avatar">${task.assignee === 'conrad' ? 'ðŸŽ­' : 'D'}</div>
                      <span>${task.assignee === 'conrad' ? 'Conrad' : 'Dom'}</span>
                    </div>
                    ${task.priority ? `<span class="task-priority ${task.priority}">${task.priority}</span>` : ''}
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        `;
        
        board.appendChild(column);
      });
    }
    
    function openModal(taskId) {
      currentTaskId = taskId;
      const task = boardData.tasks.find(t => t.id === taskId);
      if (!task) return;
      
      const effectiveColumn = getEffectiveColumn(task);
      
      document.getElementById('modal-title').textContent = task.title;
      
      const statusBadge = document.getElementById('modal-status');
      statusBadge.textContent = effectiveColumn.replace('-', ' ');
      statusBadge.className = 'status-badge ' + effectiveColumn;
      
      // Description
      const descSection = document.getElementById('modal-description-section');
      if (task.description) {
        descSection.style.display = 'block';
        document.getElementById('modal-description').textContent = task.description;
      } else {
        descSection.style.display = 'none';
      }
      
      // Deliverable
      const delivSection = document.getElementById('modal-deliverable-section');
      if (task.deliverable) {
        delivSection.style.display = 'block';
        const delivLink = document.getElementById('modal-deliverable');
        const delivPath = document.getElementById('modal-deliverable-path');
        
        // Convert local path to GitHub raw URL
        const githubBase = 'https://github.com/ddeleon82/conrad-kanban/blob/main';
        const repoBase = 'https://raw.githubusercontent.com/ddeleon82/conrad-kanban/main';
        
        if (task.deliverable.startsWith('/clawd/')) {
          // Link to the main clawd repo docs
          const docPath = task.deliverable.replace('/clawd/', '');
          delivLink.href = `https://github.com/ddeleon82/clawd/blob/main/${docPath}`;
        } else {
          delivLink.href = task.deliverable;
        }
        delivPath.textContent = task.deliverable;
      } else {
        delivSection.style.display = 'none';
      }
      
      // Meta
      document.getElementById('modal-assignee').textContent = task.assignee === 'conrad' ? 'ðŸŽ­ Conrad' : 'ðŸ‘¤ Dom';
      document.getElementById('modal-priority').textContent = task.priority ? task.priority.charAt(0).toUpperCase() + task.priority.slice(1) : '-';
      
      const completedSection = document.getElementById('modal-completed-section');
      if (task.completedAt) {
        completedSection.style.display = 'block';
        document.getElementById('modal-completed').textContent = new Date(task.completedAt).toLocaleDateString();
      } else {
        completedSection.style.display = 'none';
      }
      
      const notesSection = document.getElementById('modal-notes-section');
      if (task.notes) {
        notesSection.style.display = 'block';
        document.getElementById('modal-notes').textContent = task.notes;
      } else {
        notesSection.style.display = 'none';
      }
      
      // Comments
      renderComments(taskId);
      
      document.getElementById('modal-overlay').classList.add('open');
    }
    
    function renderComments(taskId) {
      const commentsList = document.getElementById('comments-list');
      const comments = getTaskComments(taskId);
      
      if (comments.length === 0) {
        commentsList.innerHTML = '<div class="no-comments">No comments yet</div>';
        return;
      }
      
      commentsList.innerHTML = comments.map(c => `
        <div class="comment">
          <div class="comment-header">
            <div class="comment-author">
              <span class="avatar">${c.author === 'conrad' ? 'ðŸŽ­' : 'D'}</span>
              ${c.author === 'conrad' ? 'Conrad' : 'Dom'}
            </div>
            <span class="comment-time">${formatTime(c.timestamp)}</span>
          </div>
          <div class="comment-text">${c.text}</div>
        </div>
      `).join('');
    }
    
    function formatTime(timestamp) {
      const d = new Date(timestamp);
      return d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }
    
    function closeModal() {
      document.getElementById('modal-overlay').classList.remove('open');
      document.getElementById('comment-input').value = '';
      currentTaskId = null;
    }
    
    function addComment() {
      const input = document.getElementById('comment-input');
      const text = input.value.trim();
      if (!text || !currentTaskId) return;
      
      const comment = {
        author: 'dom',
        text: text,
        timestamp: new Date().toISOString()
      };
      
      if (!localComments[currentTaskId]) {
        localComments[currentTaskId] = [];
      }
      localComments[currentTaskId].push(comment);
      localStorage.setItem('kanban-comments', JSON.stringify(localComments));
      
      input.value = '';
      renderComments(currentTaskId);
      renderBoard(boardData); // Re-render to move task to To Do
      
      // Update modal status badge
      const statusBadge = document.getElementById('modal-status');
      statusBadge.textContent = 'to do';
      statusBadge.className = 'status-badge todo';
      
      // Show toast
      showToast();
    }
    
    function showToast() {
      const toast = document.getElementById('toast');
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }
    
    // Close modal on overlay click
    document.getElementById('modal-overlay').addEventListener('click', function(e) {
      if (e.target === this) closeModal();
    });
    
    // Close modal on Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') closeModal();
    });
    
    loadBoard();
    // Auto-refresh every 30 seconds
    setInterval(loadBoard, 30000);
  </script>
</body>
</html>
